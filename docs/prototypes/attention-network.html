<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attention Network - SAKT Model</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #1a202c;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            margin: 0 0 0.5rem 0;
            color: white;
        }

        .subtitle {
            color: #a0aec0;
            margin-bottom: 2rem;
        }

        #graph-container {
            min-height: 600px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            color: #cbd5e0;
            font-size: 0.875rem;
        }

        input[type="range"] {
            width: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸ§  Attention Network</h1>
        <p class="subtitle">Visualizing Self-Attention Weights in SAKT</p>

        <div class="controls">
            <label for="threshold">Attention Threshold:</label>
            <input type="range" id="threshold" min="0" max="100" value="10" oninput="updateThreshold(this.value)">
            <span id="threshold-val">0.10</span>
        </div>

        <div id="graph-container"></div>
    </div>

    <script>
        // Mock data
        const MOCK_DATA = {
            nodes: [
                { id: "node_0", label: "Q1", group: "context" },
                { id: "node_1", label: "Q2", group: "context" },
                { id: "node_2", label: "Q3", group: "context" },
                { id: "node_3", label: "Q4", group: "context" },
                { id: "node_4", label: "Q5", group: "query" }
            ],
            links: [
                { source: "node_0", target: "node_4", weight: 0.1 },
                { source: "node_1", target: "node_4", weight: 0.2 },
                { source: "node_2", target: "node_4", weight: 0.5 },
                { source: "node_3", target: "node_4", weight: 0.15 },
                { source: "node_4", target: "node_4", weight: 0.05 }
            ]
        };

        let rawData = null;

        async function init() {
            try {
                let data;
                try {
                    const response = await fetch('../data/attention_network.json');
                    if (response.ok) {
                        data = await response.json();
                    } else {
                        throw new Error('File not found');
                    }
                } catch (e) {
                    console.warn('Using mock data:', e);
                    data = MOCK_DATA;
                }

                rawData = data;
                renderGraph(data, 0.1);

            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        function updateThreshold(val) {
            const threshold = val / 100;
            document.getElementById('threshold-val').textContent = threshold.toFixed(2);
            renderGraph(rawData, threshold);
        }

        function renderGraph(data, threshold) {
            if (!data) return;

            // Filter links
            const links = data.links.filter(l => l.weight >= threshold);

            // Simple circular layout
            const nodes = data.nodes;
            const n = nodes.length;
            const r = 1;

            const nodeX = nodes.map((_, i) => r * Math.cos(2 * Math.PI * i / n));
            const nodeY = nodes.map((_, i) => r * Math.sin(2 * Math.PI * i / n));

            // Prepare edges
            const edgeX = [];
            const edgeY = [];
            const edgeColor = [];

            links.forEach(link => {
                const sourceIdx = nodes.findIndex(n => n.id === link.source);
                const targetIdx = nodes.findIndex(n => n.id === link.target);

                if (sourceIdx >= 0 && targetIdx >= 0) {
                    edgeX.push(nodeX[sourceIdx], nodeX[targetIdx], null);
                    edgeY.push(nodeY[sourceIdx], nodeY[targetIdx], null);
                    // Opacity based on weight
                    edgeColor.push(`rgba(255, 255, 255, ${Math.min(1, link.weight * 2)})`);
                }
            });

            const edgeTrace = {
                x: edgeX,
                y: edgeY,
                mode: 'lines',
                line: { width: 1, color: '#a0aec0' }, // Simplified color for Plotly lines
                hoverinfo: 'none'
            };

            const nodeTrace = {
                x: nodeX,
                y: nodeY,
                mode: 'markers+text',
                marker: {
                    color: nodes.map(n => n.group === 'query' ? '#e53e3e' : '#3182ce'),
                    size: 20,
                    line: { width: 2, color: '#fff' }
                },
                text: nodes.map(n => n.label),
                textposition: 'top center',
                textfont: { color: '#fff' },
                hoverinfo: 'text'
            };

            const layout = {
                showlegend: false,
                hovermode: 'closest',
                margin: { b: 20, l: 20, r: 20, t: 20 },
                xaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [-1.5, 1.5] },
                yaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [-1.5, 1.5] },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                height: 600
            };

            Plotly.newPlot('graph-container', [edgeTrace, nodeTrace], layout, { responsive: true });
        }

        init();
    </script>
</body>

</html>